### Download pre-installed VmWare image
wget https://www.osboxes.org/debian/#debian-12-11-0-vmware

# Remove the default user and add a new one

sudo adduser ocel0t
sudo usermod -aG ocel0t sudo
sudo deluser osboxes

### Set networking to "Bridged" in VmWare

### Upgrade system and enable ssh

sudo apt update
sudo apt upgrade
sudo apt install openssh-server
sudo systemctl start ssh
sudo systemctl enable ssh

### Installing and configuring PostgreSQL database

sudo apt install libpq5
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql

sudo -u postgres bash
createuser --pwprompt synapse_user
createdb --encoding=UTF8 --locale=C --template=template0 --owner=synapse_user synapse

### Setting up Letâ€™s Encrypt SSL certificates

sudo apt install certbot python3-certbot-apache -y # and ensure Port Forwarding for 80 and 443

sudo certbot --apache -d "subdomain".duckdns.org # edit here
sudo systemctl status certbot.timer # setup automatic renewal routine
sudo certbot renew --dry-run # check if it's working

### Get a free hostname from duckDNS
# https://www.duckdns.org/install.jsp

sudo apt install curl
mkdir ~/duckdns
cd ~/duckdns/ 
touch duck.sh

''' CONTENT of duckdns.sh '''

#!/bin/bash
DOMAIN="" # edit here
TOKEN="" # edit here
echo url="https://www.duckdns.org/update?domains=$DOMAIN&token=$TOKEN&ip=" | curl -k -o ~/duckdns/duck.log -K -

''' CONTENT '''

*/5 * * * * ~/duckdns/duck.sh >/dev/null 2>&1  # schedule DNS updates with crontab (every 5 minutes)

### Configuring a reverse proxy

sudo apt install apache2 # installing an Apache2 web server

sudo touch /etc/apache2/sites-available/synapse.conf # creating virtual host configuration

'''CONTENT synapse.conf'''

<VirtualHost *:443>
    ServerName # edit here
    ServerAlias # edit here

    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}
    AllowEncodedSlashes NoDecode
    ProxyPreserveHost on
    ProxyPass /_matrix http://127.0.0.1:8008/_matrix nocanon
    ProxyPassReverse /_matrix http://127.0.0.1:8008/_matrix
    ProxyPass /_synapse/client http://127.0.0.1:8008/_synapse/client nocanon
    ProxyPassReverse /_synapse/client http://127.0.0.1:8008/_synapse/client


    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/"hostname"/fullchain.pem # edit here
    SSLCertificateKeyFile /etc/letsencrypt/live/"hostname"/privkey.pem # edit here
    Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>

<VirtualHost *:8448>
    ServerName # edit here

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/"hostname"/fullchain.pem # edit here
    SSLCertificateKeyFile /etc/letsencrypt/live/"hostname"/privkey.pem # edit here
    Include /etc/letsencrypt/options-ssl-apache.conf

    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}
    AllowEncodedSlashes NoDecode
    ProxyPreserveHost on
    ProxyPass /_matrix http://127.0.0.1:8008/_matrix nocanon
    ProxyPassReverse /_matrix http://127.0.0.1:8008/_matrix
</VirtualHost>

'''CONTENT'''

# enabling reverse proxy, modules for the reverse proxy and ssl

sudo a2ensite synapse.conf
sudo a2enmod proxy proxy_http headers ssl rewrite 
sudo systemctl restart apache2  

# Make Apache2 listen for federation!
echo "Listen 8448" >> /etc/apache2/ports.conf

# Don't forget to set up port forwarding to the server (80,443,8448)
